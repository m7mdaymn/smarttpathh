<!-- scan-qr.component.html -->
<div class="scan-page" dir="rtl">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <h1>๐ท ูุณุญ ุฑูุฒ QR</h1>
      <button class="back-btn" (click)="goBack()">โ ุฑุฌูุน</button>
    </div>
  </div>

  <!-- Camera Scanner Modal -->
  <div *ngIf="showCameraScanner" class="camera-modal-overlay">
    <div class="camera-modal">
      <div class="camera-header">
        <h2>๐ท ูุงุณุญ ุฑูุฒ QR</h2>
        <button class="close-camera-btn" (click)="closeCameraScanner()">ร</button>
      </div>
      <div class="camera-container">
        <video id="qr-video" autoplay playsinline></video>
        <canvas id="qr-canvas" style="display: none;"></canvas>
        <div class="scan-overlay">
          <div class="scan-region"></div>
        </div>
      </div>
      <div class="camera-instructions">
        <p>ูุฌู ุงููุงููุฑุง ูุญู ุฑูุฒ QR</p>
        <button class="manual-btn-camera" (click)="closeCameraScanner(); openManualInput()">
          โจ๏ธ ุฅุฏุฎุงู ูุฏูู ุจุฏูุงู ูู ุฐูู
        </button>
      </div>
    </div>
  </div>

  <!-- Scan Area -->
  <div class="scan-section">
    <div class="scan-area">
      <div class="scan-frame">
        <div class="scan-placeholder">
          ๐ท
        </div>
      </div>
      
      <div class="scan-actions">
        <button class="scan-btn" (click)="openCamera()">
          ๐ ูุชุญ ุงููุงููุฑุง
        </button>
        <button class="manual-btn" (click)="openManualInput()">
          โจ๏ธ ุฅุฏุฎุงู ูุฏูู
        </button>
      </div>
    </div>

    <!-- Quick Instructions -->
    <div class="instructions">
      <h3>ููููุฉ ุงูุงุณุชุฎุฏุงู:</h3>
      <ul>
        <li>ูุฌู ุงููุงููุฑุง ูุญู ุฑูุฒ QR ููุนููู</li>
        <li>ุงูุชุธุฑ ุญุชู ูุชู ุงูุชุนุฑู ุชููุงุฆูุงู</li>
        <li>ุฃู ุฃุฏุฎู ุงูุฑูุฒ ูุฏููุงู</li>
      </ul>
    </div>
  </div>

  <!-- Manual Input Modal -->
  <div *ngIf="showManualInput" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h2>ุฅุฏุฎุงู ุฑูุฒ QR ูุฏููุงู</h2>
        <button class="close-btn" (click)="closeManualInput()">ร</button>
      </div>
      
      <div class="modal-body">
        <div class="input-group">
          <label>ุฑูุฒ QR</label>
          <input type="text" 
                 [(ngModel)]="manualQRCode"
                 placeholder="DP-CUST-XXXX"
                 (keyup.enter)="submitManualQR()">
        </div>
        
        <button class="submit-btn" (click)="submitManualQR()">
          ุชุฃููุฏ
        </button>
      </div>
    </div>
  </div>

  <!-- Scan Result -->
  <div *ngIf="scanResult" class="scan-result" [ngClass]="scanResult.status">
    <div class="result-header">
      <div class="result-icon">
        {{ scanResult.status === 'success' ? 'โ' : 'โ' }}
      </div>
      <h2>{{ scanResult.title }}</h2>
    </div>
    
    <div class="result-body">
      <div class="customer-info">
        <div class="customer-details">
          <h3>{{ scanResult.customerName }}</h3>
          <p>{{ scanResult.customerPhone }}</p>
          <p *ngIf="scanResult.carPlateNumber" class="car-plate">
            ๐ ุฑูู ุงูุณูุงุฑุฉ: {{ scanResult.carPlateNumber }}
          </p>
        </div>
      </div>
      
      <!-- Car Photo Display (if available) -->
      <div class="car-photo-display" *ngIf="scanResult.customerPhoto">
        <h4>๐ท ุตูุฑุฉ ุณูุงุฑุฉ ุงูุนููู</h4>
        <div class="car-photo-container">
          <img [src]="getFullPhotoUrl(scanResult.customerPhoto)" alt="ุตูุฑุฉ ุณูุงุฑุฉ ุงูุนููู" class="car-photo-img">
        </div>
      </div>
      
      <!-- <div class="progress-info">
        <div class="progress-label">
          <span>ุงูุชูุฏู</span>
          <span>{{ scanResult.currentWashes }} / {{ scanResult.washesRequired }}</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="scanResult.progress"></div>
        </div>
        <div class="remaining-washes-info">
          <span class="gift-icon">๐</span>
          <span>ูุชุจูู {{ scanResult.washesRequired - scanResult.currentWashes }} ุบุณูุงุช ูููุฏูุฉ</span>
        </div>
      </div> -->
      
      <div class="time-info" *ngIf="scanResult.daysLeft > 0">
        <span class="time-label">ุงูููุช ุงููุชุจูู:</span>
        <span class="time-value">{{ scanResult.daysLeft }} ููู</span>
      </div>
      
      <div *ngIf="scanResult.rewardEarned" class="reward-alert">
        ๐ ูุจุฑูู! ุงูุนููู ุงุณุชุญู ุงูููุงูุฃุฉ
      </div>
      
      <div *ngIf="!scanResult.canAddWash" class="warning-alert">
        โ๏ธ ูุง ูููู ุฅุถุงูุฉ ุบุณูุฉ ุงูููู
      </div>
    </div>
    
    <!-- Wash Details Form -->
    <div *ngIf="showWashForm && scanResult.status === 'success'" class="wash-form-section">
      <h3>ุชูุงุตูู ุงูุบุณูุฉ</h3>
      
      <div class="form-group">
        <label>ุงุณู ุงูุฎุฏูุฉ / ููุน ุงูุบุณูู *</label>
        <input type="text" 
               [(ngModel)]="washDetails.serviceName" 
               placeholder="ูุซุงู: ุบุณูู ุนุงุฏูุ ุชูุธูู ุฏุงุฎููุ ุชูููุน..."
               required>
      </div>
      
      <div class="form-group">
        <label>ุงููุจูุบ (ุฑูุงู) - ุงุฎุชูุงุฑู</label>
        <input type="number" 
               [(ngModel)]="washDetails.amount" 
               min="0" 
               placeholder="0 ููุฎุฏูุงุช ุงููุฌุงููุฉ">
      </div>
      
      <div class="form-group">
        <label>ุชูุงุตูู ุฅุถุงููุฉ (ุงุฎุชูุงุฑู)</label>
        <textarea [(ngModel)]="washDetails.notes" 
                  placeholder="ุฃู ุชูุงุตูู ุฃู ููุงุญุธุงุช ุฅุถุงููุฉ..."
                  rows="3"></textarea>
      </div>
      
      <div class="form-actions">
        <button class="submit-wash-btn" 
                (click)="recordWash()" 
                [disabled]="isSubmittingWash">
          <span *ngIf="!isSubmittingWash">โ ุชุณุฌูู ุงูุบุณูุฉ</span>
          <span *ngIf="isSubmittingWash">ุฌุงุฑู ุงูุชุณุฌูู...</span>
        </button>
        <button class="cancel-btn" (click)="cancelWashForm()">
          ุฅูุบุงุก
        </button>
      </div>
    </div>
    
    <div class="result-actions">
      <button class="done-btn" (click)="resetScan()">ุชู</button>
      <button class="new-btn" (click)="scanAgain()">ูุณุญ ุขุฎุฑ</button>
    </div>
  </div>

  <!-- Reward Scan Result -->
  <div *ngIf="rewardScanResult" class="scan-result reward-result" [ngClass]="rewardScanResult.status">
    <div class="result-header">
      <div class="result-icon">
        {{ rewardScanResult.status === 'success' ? '๐' : (rewardScanResult.status === 'claimed' ? 'โ' : 'โ') }}
      </div>
      <h2>{{ rewardScanResult.title }}</h2>
    </div>
    
    <div class="result-body">
      <div class="customer-info">
        <div class="customer-photo">
          <span>๐ค</span>
        </div>
        <div class="customer-details">
          <h3>{{ rewardScanResult.customerName }}</h3>
          <p>{{ rewardScanResult.customerPhone }}</p>
        </div>
      </div>
      
      <div class="reward-info-section">
        <div class="reward-detail-row">
          <span class="reward-icon">๐</span>
          <span class="reward-label">ููุน ุงูููุงูุฃุฉ:</span>
          <span class="reward-value">{{ rewardScanResult.rewardTitle }}</span>
        </div>
        
        <div class="reward-detail-row" *ngIf="rewardScanResult.rewardValue > 0">
          <span class="reward-icon">๐ฐ</span>
          <span class="reward-label">ุงููููุฉ:</span>
          <span class="reward-value">{{ rewardScanResult.rewardValue }} ุฑ.ุณ</span>
        </div>
        
        <div class="reward-detail-row" *ngIf="rewardScanResult.rewardExpiresAt">
          <span class="reward-icon">๐</span>
          <span class="reward-label">ุชูุชูู:</span>
          <span class="reward-value">{{ rewardScanResult.rewardExpiresAt | date:'shortDate' }}</span>
        </div>
      </div>
      
      <div *ngIf="rewardScanResult.message" class="reward-message">
        {{ rewardScanResult.message }}
      </div>
      
      <div *ngIf="rewardScanResult.status === 'success' && !rewardScanResult.isAlreadyClaimed" class="redeem-section">
        <button class="redeem-btn" 
                (click)="redeemReward()" 
                [disabled]="isRedeemingReward">
          <span *ngIf="!isRedeemingReward">โ ุงุณุชุฎุฏุงู ุงูููุงูุฃุฉ</span>
          <span *ngIf="isRedeemingReward">ุฌุงุฑู ุงููุนุงูุฌุฉ...</span>
        </button>
      </div>
      
      <div *ngIf="rewardScanResult.isAlreadyClaimed" class="claimed-notice">
        โ ุชู ุงุณุชุฎุฏุงู ูุฐู ุงูููุงูุฃุฉ ูุณุจูุงู
      </div>
      
      <div *ngIf="rewardScanResult.isExpired" class="expired-notice">
        โ๏ธ ุงูุชูุช ุตูุงุญูุฉ ูุฐู ุงูููุงูุฃุฉ
      </div>
    </div>
    
    <div class="result-actions">
      <button class="done-btn" (click)="resetScan()">ุชู</button>
      <button class="new-btn" (click)="scanAgain()">ูุณุญ ุขุฎุฑ</button>
    </div>
  </div>
  
  <!-- Loading Overlay -->
  <div *ngIf="isLoading" class="loading-overlay">
    <div class="spinner"></div>
    <p>ุฌุงุฑู ุงููุนุงูุฌุฉ...</p>
  </div>
</div>